pipeline {
    agent any
    stages {
        stage ("Prepare Jenkinsfile") {
            steps {
                script {
                    sh """
                        printf '%s\n' "def call() {" | cat - Jenkinsfile > TestJenkinsfile.groovy
                        sed -i "132i }" TestJenkinsfile.groovy
                    """
                }
            }
        }
        stage ("Prepare repository files") {
            steps {
                script {
                    echo "Preparing workspace for test job"
                }
            }
        }
        stage ("Run Jenkinsfile") {
            steps {
                script {
                    def test_jenkinsfile = load("TestJenkinsfile.groovy")
                    test_jenkinsfile.call()
                }
            }
        }
    }
}