pipeline {
    agent any
    stages {
        stage ("Prepare Jenkinsfile") {
            steps {
                script {
                    sh """
                        printf '%s\n' "def test() {" | cat - Jenkinsfile > TestJenkinsfile.groovy; printf '\n%s' "}" >> TestJenkinsfile.groovy
                    """
                }
            }
        }
        stage ("Prepare repository files") {
            steps {
                script {
                    echo "Preparing workspace for test job"
                }
            }
        }
        stage ("Run Jenkinsfile") {
            steps {
                script {
                    def test_jenkinsfile = load("TestJenkinsfile.groovy")
                    test_jenkinsfile.test()
                }
            }
        }
    }
}